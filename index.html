<html>
  <body align="center">
    <div>Object Detection Game</div>
    <button type="button" onclick="startGame()">Start Game</button>
    <div id="timer-container"></div>
    <div id="score-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
      const URL = "https://teachablemachine.withgoogle.com/models/fhATAqKV1/";
      const maxPredictions = 10;
      let model, webcam, score, timer;

      async function startGame() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        score = 0;
        timer = 60;
        document.getElementById("score-container").innerHTML = `Score: ${score}`;

        const flip = true;
        webcam = new tmImage.Webcam(200, 200, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        const timerInterval = setInterval(() => {
          timer--;
          document.getElementById("timer-container").innerHTML = `Time: ${timer}s`;
          if (timer === 0) {
            clearInterval(timerInterval);
            endGame();
          }
        }, 1000);
      }

      async function loop() {
        webcam.update();
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
          const className = prediction[i].className;
          const probability = prediction[i].probability.toFixed(2);
          if (probability >= 0.6 && className !== "background") {
            score++;
            document.getElementById("score-container").innerHTML = `Score: ${score}`;
            await sleep(1000); // prevent multiple detections of same object
          }
        }
        window.requestAnimationFrame(loop);
      }

      function endGame() {
        webcam.stop();
        alert(`Game Over! Your score is ${score}`);
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
    </script>
  </body>
</html>
